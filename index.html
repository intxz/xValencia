<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>xValencia - Alertas en Tiempo Real</title>
  </head>

  <body>
    <header>
      <h1>Centro de Alertas de xValencia</h1>
      <p>Alertas en tiempo real para la comunidad</p>
    </header>

    <button type="button" id="danger-alert-btn" onclick="llamar112()">
      Botón del pánico
    </button>
    <small>
      Este botón es exclusivamente para indicar un peligro inminente y permite
      crear una alerta con alta prioridad, además de ofrecer la opción de llamar
      al 112.
      <strong
        >No reemplaza las llamadas de emergencia habituales y estas deben ser
        realizadas en caso de necesidad inmediata.</strong
      >
    </small>

    <main>
      <section id="publish-alert">
        <h2>Publicar una Nueva Alerta</h2>
        <form id="alert-form">
          <label for="title">Título de la Alerta:</label>
          <input type="text" id="title" required />

          <label for="description">Descripción:</label>
          <textarea id="description" required></textarea>

          <label for="priority">Prioridad:</label>
          <select id="priority" required>
            <option value="alta">Alta</option>
            <option value="media" selected>Media</option>
            <option value="baja">Baja</option>
          </select>

          <button type="submit">Enviar Alerta</button>
        </form>
      </section>
      <section id="alerts">
        <h2>Alertas Actuales</h2>
        <small
          >Estas alertas tienen un tiempo de vida de 24 horas y, después de ese
          período, se eliminarán automáticamente.</small
        >
        <div id="alert-list"></div>
      </section>
    </main>

    <script type="module">
      const BASE_URL = 'https://xvalencia-backend.onrender.com';

      // Obtener alertas
      async function fetchAlerts() {
        try {
          const response = await fetch(`${BASE_URL}/alerts`);
          const alerts = await response.json();
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                displayAlerts(alerts, userLat, userLon);
              },
              () => displayAlerts(alerts)
            );
          } else {
            displayAlerts(alerts);
          }
        } catch (error) {
          console.error('Error obteniendo alertas:', error);
        }
      }

      function toRad(angle) {
        return (angle * Math.PI) / 180;
      }
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const toRad = (angle) => (angle * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Mostrar alertas en la interfaz
      function displayAlerts(alerts, userLat = null, userLon = null) {
        const alertList = document.getElementById('alert-list');
        alertList.innerHTML = '';

        alerts.sort((a, b) => {
          const priorityOrder = {
            extrema: 1,
            alta: 2,
            media: 3,
            baja: 4,
          };
          const priorityDifference =
            (priorityOrder[a.priority] || 5) - (priorityOrder[b.priority] || 5);
          if (
            priorityDifference === 0 &&
            userLat !== null &&
            userLon !== null &&
            a.latitude &&
            a.longitude &&
            b.latitude &&
            b.longitude
          ) {
            const distanceA = calculateDistance(
              userLat,
              userLon,
              a.latitude,
              a.longitude
            );
            const distanceB = calculateDistance(
              userLat,
              userLon,
              b.latitude,
              b.longitude
            );
            return distanceA - distanceB;
          }

          return priorityDifference;
        });

        alerts.forEach((alert) => {
          const alertItem = document.createElement('div');
          alertItem.classList.add('alert-item');
          if (alert.priority === 'extrema') alertItem.classList.add('extrema');

          let distanceText = '';
          if (alert.latitude && alert.longitude && userLat && userLon) {
            const distance = calculateDistance(
              userLat,
              userLon,
              alert.latitude,
              alert.longitude
            );
            distanceText = `<p>Distancia: ${distance.toFixed(0)} metros ${
              distance < 500 ? '<strong>(Cerca)</strong>' : ''
            }</p>`;
          }
          alertItem.innerHTML = `
            <h3>${alert.title}</h3>
            <p>${alert.description}</p>
            <p>Prioridad: ${alert.priority || 'media'}</p>
            <p>${alert.latitude}, ${alert.longitude}</p>
            </p>${distanceText}</p>
            <p>${new Date(alert.timestamp).toLocaleString()}</p>
            <p><strong>Personas ayudando: ${alert.helpCount || 0}</strong></p>
            <button onclick="irAAyudar('${alert.id}')">Ir a Ayudar</button>
            <section id="messages-${alert.id}">
            <h4>Mensajes</h4>
            <div id="message-list-${alert.id}">
            ${
              alert.messages && alert.messages.length > 0
                ? alert.messages.map((msg) => `<p>- ${msg}</p>`).join('')
                : '<p>No hay mensajes aún</p>'
            }
            </div>
            <textarea id="message-input-${
              alert.id
            }" placeholder="Escribe un mensaje"></textarea>
            <button onclick="enviarMensaje('${
              alert.id
            }')">Enviar Mensaje</button>
            </section>
          `;
          alertList.appendChild(alertItem);
        });
      }

      // Publicar una alerta
      async function publicarAlerta(
        title,
        description,
        priority,
        latitude,
        longitude
      ) {
        try {
          await fetch(`${BASE_URL}/alerts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              description,
              priority,
              latitude,
              longitude,
            }),
          });
          fetchAlerts(); // Actualiza la lista de alertas después de publicar
        } catch (error) {
          console.error('Error al enviar la alerta:', error);
        }
      }

      async function irAAyudar(alertId) {
        try {
          await fetch(`${BASE_URL}/alerts/${alertId}/help`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
          });
          fetchAlerts();
        } catch (error) {
          console.error('Error al actualizar el contador de ayuda:', error);
        }
      }

      async function enviarMensaje(alertId) {
        const messageInput = document.getElementById(
          `message-input-${alertId}`
        );
        const message = messageInput.value;

        if (message.trim() === '') return; // No enviar mensajes vacíos

        try {
          await fetch(`${BASE_URL}/alerts/${alertId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message }),
          });
          fetchAlerts(); // Actualiza los mensajes después de enviar uno nuevo
          messageInput.value = ''; // Limpiar el campo de mensaje
        } catch (error) {
          console.error('Error al enviar el mensaje:', error);
        }
      }

      // Manejo del formulario de alertas
      const alertForm = document.getElementById('alert-form');
      alertForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const priority = document.getElementById('priority').value;

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;
              publicarAlerta(title, description, priority, latitude, longitude);
            },
            () => {
              publicarAlerta(title, description, priority, null, null);
            }
          );
        } else {
          publicarAlerta(title, description, priority, null, null);
        }
        alertForm.reset();
      });

      // Botón de emergencia
      function llamar112() {
        const title = '¡Peligro Inmediato!';
        const description = 'Llamada de emergencia solicitada';
        const priority = 'extrema';
        window.location.href = 'tel:112';

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;
              publicarAlerta(title, description, priority, latitude, longitude);
            },
            () => {
              publicarAlerta(title, description, priority, null, null);
            }
          );
        } else {
          publicarAlerta(title, description, priority, null, null);
        }
      }

      window.llamar112 = llamar112;
      window.irAAyudar = irAAyudar;
      window.enviarMensaje = enviarMensaje;

      // Inicializar al cargar la página
      fetchAlerts();
    </script>
  </body>
</html>
